name: Build & Release Chopcord

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build and release"
        required: true
        default: "1.0.0"

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
# --------------------------------------------------
# VALIDATE
# --------------------------------------------------
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt flake8
          flake8 .

# --------------------------------------------------
# WINDOWS x64
# --------------------------------------------------
  build-windows-x64:
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: x64
      - uses: ./.github/actions/setup-build
      - shell: pwsh
        run: |
          & .\.venv\Scripts\activate
          $v="${{ github.event.inputs.version }}"
          python -m nuitka chopcord.py `
            --standalone `
            --onefile `
            --disable-console `
            --include-data-dir=web=web `
            --include-data-files=logo.png=logo.png `
            --windows-icon-from-ico=logo.ico `
            --output-dir=dist `
            --output-filename="chopcord-windows-x64-v$v.exe" `
            --assume-yes-for-downloads
      - shell: pwsh
        run: |
          Compress-Archive dist\chopcord-windows-x64-v${{ github.event.inputs.version }}.exe `
                           dist\chopcord-windows-x64-v${{ github.event.inputs.version }}.zip
      - uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: dist/chopcord-windows-x64-v*.zip

# --------------------------------------------------
# WINDOWS x86 (32-bit)
# --------------------------------------------------
  build-windows-x86:
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: x86
      - uses: ./.github/actions/setup-build
      - shell: pwsh
        run: |
          & .\.venv\Scripts\activate
          $v="${{ github.event.inputs.version }}"
          python -m nuitka chopcord.py `
            --standalone `
            --onefile `
            --disable-console `
            --include-data-dir=web=web `
            --include-data-files=logo.png=logo.png `
            --windows-icon-from-ico=logo.ico `
            --output-dir=dist `
            --output-filename="chopcord-windows-x86-v$v.exe" `
            --assume-yes-for-downloads
      - shell: pwsh
        run: |
          Compress-Archive dist\chopcord-windows-x86-v${{ github.event.inputs.version }}.exe `
                           dist\chopcord-windows-x86-v${{ github.event.inputs.version }}.zip
      - uses: actions/upload-artifact@v4
        with:
          name: windows-x86
          path: dist/chopcord-windows-x86-v*.zip

# --------------------------------------------------
# LINUX x64
# --------------------------------------------------
  build-linux-x64:
    runs-on: ubuntu-22.04
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: ./.github/actions/setup-build
      - run: |
          sudo apt update
          sudo apt install -y libgtk-3-0 libwebkit2gtk-4.0-37
      - run: |
          source .venv/bin/activate
          python -m nuitka chopcord.py \
            --standalone \
            --onefile \
            --disable-console \
            --include-data-dir=web=web \
            --output-dir=dist \
            --output-filename="chopcord-linux-x64-v${{ github.event.inputs.version }}"
      - run: |
          tar -czvf chopcord-linux-x64-v${{ github.event.inputs.version }}.tar.gz \
            -C dist chopcord-linux-x64-v${{ github.event.inputs.version }}
      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: chopcord-linux-x64-v*.tar.gz

# --------------------------------------------------
# macOS ARM64
# --------------------------------------------------
  build-macos-arm64:
    runs-on: macos-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: ./.github/actions/setup-build
      - run: |
          source .venv/bin/activate
          python -m nuitka chopcord.py \
            --standalone \
            --macos-create-app-bundle \
            --macos-sign-identity="-" \
            --macos-app-name="Chopcord" \
            --macos-app-icon=logo.icns \
            --macos-app-version="${{ github.event.inputs.version }}" \
            --include-data-dir=web=web \
            --assume-yes-for-downloads \
            --output-dir=build-arm64
      - run: |
          APP=$(find build-arm64 -name "*.app" | head -n1)
          mv "$APP" "Chopcord-arm64-v${{ github.event.inputs.version }}.app"
      - run: |
          hdiutil create \
            -volname "Chopcord ARM64" \
            -srcfolder "Chopcord-arm64-v${{ github.event.inputs.version }}.app" \
            -format UDZO \
            -ov \
            -o "chopcord-macos-arm64-v${{ github.event.inputs.version }}.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: chopcord-macos-arm64-v*.dmg

# --------------------------------------------------
# macOS INTEL (x64)
# --------------------------------------------------
  build-macos-intel:
    runs-on: macos-13
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: ./.github/actions/setup-build
      - run: |
          source .venv/bin/activate
          python -m nuitka chopcord.py \
            --standalone \
            --macos-create-app-bundle \
            --macos-sign-identity="-" \
            --macos-app-name="Chopcord" \
            --macos-app-icon=logo.icns \
            --macos-app-version="${{ github.event.inputs.version }}" \
            --include-data-dir=web=web \
            --assume-yes-for-downloads \
            --output-dir=build-intel
      - run: |
          APP=$(find build-intel -name "*.app" | head -n1)
          mv "$APP" "Chopcord-intel-v${{ github.event.inputs.version }}.app"
      - run: |
          hdiutil create \
            -volname "Chopcord Intel" \
            -srcfolder "Chopcord-intel-v${{ github.event.inputs.version }}.app" \
            -format UDZO \
            -ov \
            -o "chopcord-macos-intel-v${{ github.event.inputs.version }}.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: macos-intel
          path: chopcord-macos-intel-v*.dmg

# --------------------------------------------------
# RELEASE
# --------------------------------------------------
  release:
    runs-on: ubuntu-22.04
    needs:
      - build-windows-x64
      - build-windows-x86
      - build-linux-x64
      - build-macos-arm64
      - build-macos-intel

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract Changelog Section
        run: |
          VERSION="v${{ github.event.inputs.version }}"
          awk -v ver="$VERSION" '
            $0 ~ "^## " ver {flag=1; next}
            flag && /^## / {exit}
            flag {print}
          ' CHANGELOG.md > RELEASE_NOTES.md

      - name: Generate Checksums + Download Table
        run: |
          VERSION="${{ github.event.inputs.version }}"
          cat >> RELEASE_NOTES.md <<EOF

          ## ðŸ§© Downloads

          | Downloads | Compatibility |
          |---|---|
          | Windows x64 | Windows 10+ |
          | Windows x86 | Windows 7+ (32-bit, Legacy) |
          | macOS ARM64 | macOS 11+ |
          | macOS Intel | macOS 10.15+ |
          | Linux x64 | GNOME / KDE |

          EOF

          echo "## ðŸ” Checksums" >> RELEASE_NOTES.md
          find artifacts -type f -exec sha256sum {} \; | while read s f; do
            echo "- **$(basename "$f")**: \`$s\`" >> RELEASE_NOTES.md
          done

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Chopcord v${{ github.event.inputs.version }}
          body_path: RELEASE_NOTES.md
          prerelease: true
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
