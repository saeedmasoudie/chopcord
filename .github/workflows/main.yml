name: Build & Release Chopcord

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build and release"
        required: true
        default: "1.0.1"

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
# --------------------------------------------------
# VALIDATION
# --------------------------------------------------
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt flake8
          flake8 .

# --------------------------------------------------
# WINDOWS x64
# --------------------------------------------------
  build-windows-x64:
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x64"

      - uses: ./.github/actions/setup-build

      - name: Build Windows x64
        shell: pwsh
        run: |
          & .\.venv\Scripts\activate
          $v="${{ github.event.inputs.version }}"

          python -m nuitka chopcord.py `
            --standalone `
            --onefile `
            --disable-console `
            --include-data-dir=web=web `
            --include-data-files=logo.png=logo.png `
            --windows-icon-from-ico=logo.ico `
            --windows-file-version="$v" `
            --output-dir=dist `
            --output-filename="chopcord-windows-x64-v$v.exe" `
            --assume-yes-for-downloads

      - run: |
          Compress-Archive dist\chopcord-windows-x64-v${{ github.event.inputs.version }}.exe `
            dist\chopcord-windows-x64-v${{ github.event.inputs.version }}.zip
        shell: pwsh

      - uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: dist/chopcord-windows-x64-v*.zip

# --------------------------------------------------
# WINDOWS x86 (32-bit)
# --------------------------------------------------
  build-windows-x86:
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x86"

      - uses: ./.github/actions/setup-build

      - name: Build Windows x86
        shell: pwsh
        run: |
          & .\.venv\Scripts\activate
          $v="${{ github.event.inputs.version }}"

          python -m nuitka chopcord.py `
            --standalone `
            --onefile `
            --disable-console `
            --include-data-dir=web=web `
            --include-data-files=logo.png=logo.png `
            --windows-icon-from-ico=logo.ico `
            --windows-file-version="$v" `
            --output-dir=dist `
            --output-filename="chopcord-windows-x86-v$v.exe" `
            --assume-yes-for-downloads

      - run: |
          Compress-Archive dist\chopcord-windows-x86-v${{ github.event.inputs.version }}.exe `
            dist\chopcord-windows-x86-v${{ github.event.inputs.version }}.zip
        shell: pwsh

      - uses: actions/upload-artifact@v4
        with:
          name: windows-x86
          path: dist/chopcord-windows-x86-v*.zip

# --------------------------------------------------
# LINUX x64
# --------------------------------------------------
  build-linux-x64:
    runs-on: ubuntu-22.04
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: ./.github/actions/setup-build

      - run: |
          sudo apt update
          sudo apt install -y libgtk-3-0 libwebkit2gtk-4.0-37

      - run: |
          source .venv/bin/activate
          python -m nuitka chopcord.py \
            --standalone \
            --onefile \
            --disable-console \
            --include-data-dir=web=web \
            --output-dir=dist \
            --output-filename="chopcord-linux-x64-v${{ github.event.inputs.version }}"

      - run: |
          tar -czvf chopcord-linux-x64-v${{ github.event.inputs.version }}.tar.gz \
            -C dist chopcord-linux-x64-v${{ github.event.inputs.version }}

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: chopcord-linux-x64-v*.tar.gz

# -------------------------
# RELEASE
# -------------------------
  release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs:
      - build-windows-x64
      - build-windows-x86
      - build-linux
      - build-macos-arm64
      - build-macos-intel

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract Changelog Section
        run: |
          VERSION="v${{ github.event.inputs.version }}"
          awk -v ver="$VERSION" '
            $0 ~ "^## " ver {flag=1; next}
            flag && /^## / {exit}
            flag {print}
          ' CHANGELOG.md > RELEASE_NOTES.md

      - name: Generate Checksums + Download Table
        shell: bash
        run: |
          REPO="${{ github.repository }}"
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"

          WIN_X64=$(find artifacts -name "*windows-x64*.zip" | head -n1 || true)
          WIN_X86=$(find artifacts -name "*windows-x86*.zip" | head -n1 || true)
          LINUX_X64=$(find artifacts -name "*linux-x64*.tar.gz" | head -n1 || true)
          MAC_ARM_DMG=$(find artifacts -name "*macos-arm64*.dmg" | head -n1 || true)
          MAC_ARM_PKG=$(find artifacts -name "*macos-arm64*.pkg" | head -n1 || true)
          MAC_INTEL_DMG=$(find artifacts -name "*macos-intel*.dmg" | head -n1 || true)
          MAC_INTEL_PKG=$(find artifacts -name "*macos-intel*.pkg" | head -n1 || true)

          cat >> RELEASE_NOTES.md <<EOF

          ## ðŸ§© Downloads

          | <div align="center">Downloads</div> | <div align="center">Compatibility</div> |
          |---|---|
          | [![Windows x64](https://img.shields.io/badge/Windows-x64-0078D6?style=for-the-badge&logo=windows&logoColor=white)](https://github.com/${REPO}/releases/download/${TAG}/chopcord-windows-x64-v${VERSION}.zip) | Windows 10+ |
          | [![Windows x86](https://img.shields.io/badge/Windows-x86-0078D6?style=for-the-badge&logo=windows&logoColor=white)](https://github.com/${REPO}/releases/download/${TAG}/chopcord-windows-x86-v${VERSION}.zip) | Windows 7+ (32-bit, Legacy) |
          | [![macOS ARM64](https://img.shields.io/badge/macOS-ARM64-FFFFFF?style=for-the-badge&logo=apple&logoColor=black)](https://github.com/${REPO}/releases/download/${TAG}/chopcord-macos-arm64-v${VERSION}.dmg) [![PKG ARM64](https://img.shields.io/badge/PKG-ARM64-AAAAAA?style=for-the-badge&logo=apple&logoColor=black)](https://github.com/${REPO}/releases/download/${TAG}/chopcord-macos-arm64-v${VERSION}.pkg) <br/> [![macOS Intel](https://img.shields.io/badge/macOS-Intel-FFFFFF?style=for-the-badge&logo=apple&logoColor=black)](https://github.com/${REPO}/releases/download/${TAG}/chopcord-macos-intel-v${VERSION}.dmg) [![PKG Intel](https://img.shields.io/badge/PKG-Intel-AAAAAA?style=for-the-badge&logo=apple&logoColor=black)](https://github.com/${REPO}/releases/download/${TAG}/chopcord-macos-intel-v${VERSION}.pkg) | macOS 10.15+ |
          | [![Linux x64](https://img.shields.io/badge/Linux-x64-FCC624?style=for-the-badge&logo=linux&logoColor=black)](https://github.com/${REPO}/releases/download/${TAG}/chopcord-linux-x64-v${VERSION}.tar.gz) | GNOME / KDE |

          EOF

          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ” Checksums" >> RELEASE_NOTES.md

          for file in \
              "$WIN_X64" \
              "$WIN_X86" \
              "$LINUX_X64" \
              "$MAC_ARM_DMG" "$MAC_ARM_PKG" \
              "$MAC_INTEL_DMG" "$MAC_INTEL_PKG"
          do
            if [ -f "$file" ]; then
              sha=$(sha256sum "$file" | cut -d' ' -f1)
              name=$(basename "$file")
              echo "- **$name:** \`$sha\`" >> RELEASE_NOTES.md
            fi
          done

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Chopcord v${{ github.event.inputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: true
          files: |
            artifacts/**/*windows*.zip
            artifacts/**/*linux*.tar.gz
            artifacts/**/*macos*.dmg
            artifacts/**/*macos*.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

